# Миграции проектной БД

## Где хранить версию схемы

**В самой проектной БД** — тогда каждый файл проекта знает свою версию.

Варианты:

- Таблица **`_schema_version`** с одной строкой: `version INTEGER`.
- Либо таблица **`_migrations`**: `(id, name, applied_at)` — список уже применённых миграций.

## Как это работает при открытии БД

1. Открыли файл проектной БД (при выборе проекта или при старте).
2. **Прочитали текущую версию:**
   - Если таблицы `_schema_version` нет → считаем версию `0` (новая БД или старая без миграций).
   - Если есть → `SELECT version FROM _schema_version LIMIT 1`.
3. В коде задана **целевая версия** (константа `LATEST_SCHEMA_VERSION`).
4. Если `currentVersion < LATEST_SCHEMA_VERSION` — по очереди выполняете миграции: `0 → 1`, `1 → 2`, … до целевой.
5. После каждой миграции обновляете `_schema_version`.

## Структура миграций в коде

Миграции — упорядоченный список шагов (SQL или функции), каждый шаг переводит схему с версии N на N+1.

- Один общий список миграций в приложении (массив в `migrations/projectDb.ts` или папка `migrations/` с файлами `001_initial.sql`, `002_add_last_crawled.sql`).
- Применяются **только к проектной БД** при её открытии.
- Системная БД может иметь свой отдельный набор миграций и свою таблицу версий.

## Версия 0 (новая БД)

Для только что созданного проекта при первом открытии `_schema_version` нет → считаем версию 0. Применяются все миграции с 0 до `LATEST_SCHEMA_VERSION` (включая «начальную» миграцию, которая создаёт таблицы и саму `_schema_version`).
